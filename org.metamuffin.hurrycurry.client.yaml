app-id: org.metamuffin.hurrycurry.client
runtime: org.freedesktop.Platform
runtime-version: "23.08"
sdk: org.freedesktop.Sdk
command: hurrycurry
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --device=dri
  - --share=network

build-options:
  arch:
    x86_64:
      env:
        # Only enable link-time optimization when targeting x86_64
        # (causes issues on other architectures)
        SCONS_FLAGS_EXTRA: use_lto=yes

  env:
    BUILD_NAME: hurrycurry

modules:
  - shared-modules/glu/glu-9.json

  - name: scons
    buildsystem: simple
    cleanup: ["*"]

    sources:
      - type: archive
        sha256: 6e928fc97984e719814270f6863f2183b3b72180b0162a5ed09db68c9994100c
        url: https://downloads.sourceforge.net/project/scons/scons/4.8.0/SCons-4.8.0.tar.gz

    build-commands:
      - python3 -m pip install --no-index --no-build-isolation --prefix=/app .

  - name: godot
    buildsystem: simple

    sources:
      - type: archive
        sha256: 751e55bfad8e04b846f9cf7b6eb80e058986a2cb1b103fc0fe6a4d8526a20e56
        url: https://downloads.tuxfamily.org/godotengine/4.3/godot-4.3-stable.tar.xz

      - type: file
        path: custom.py

    build-commands:
      - python3 /app/bin/scons $SCONS_FLAGS_EXTRA profile=custom.py target=editor -j "$FLATPAK_BUILDER_N_JOBS"
      - python3 /app/bin/scons $SCONS_FLAGS_EXTRA profile=custom.py target=template_release -j "$FLATPAK_BUILDER_N_JOBS"
      - install -Dm755 bin/godot.linuxbsd.template_release.* /app/bin/godot
      - install -Dm755 bin/godot.linuxbsd.editor.* /app/bin/godot-editor

  - name: hurrycurry
    buildsystem: simple
    sources:
      - type: archive
        sha256: bb93398c76b063af1479305150440c1a797195e9c7a870a7c9b387750141ce41
        url: https://codeberg.org/hurrycurry/hurrycurry/archive/v2.0.0.tar.gz

      - type: file
        sha256: 294062c1e23a47f6bf4277ab5bcd51c9ddcb65fd5ece22b48c0171b465a9d3e7
        url: https://s.metamuffin.org/static/hurrycurry-2.0/book.webp.tar.zst

      - type: archive
        sha256: 151fb4fcec92a59a8991154fddc51c165b2362cc27a26cf5dafe36ef9ef22cc9
        url: https://codeberg.org/hurrycurry/hurrycurry-dist-extra/archive/v2.0.0.tar.gz
      
      - type: archive
        sha256: d3a69a6d27baf68c40ff7ca6ee5309b7aa233f80d8cd7c2c827837e78ef84c08
        url: https://codeberg.org/hurrycurry/hurrycurry/releases/download/v2.0.0/translations-po.tar.xz

    build-commands:
      - tar -xf book.webp.tar.zst -C client/menu/book
      - mkdir client/po
      - tar -xf translations-po.tar.xz -C client/po
      - install -dD /app/share/hurrycurry
      - godot-editor --headless --export-pack wasm32-unknown-unknown /app/share/hurrycurry/client.pck client/project.godot
      - rm /app/bin/godot-editor
      - install -Dm755 hurrycurry /app/bin/hurrycurry
      - install -Dm644 org.metamuffin.hurrycurry.client.desktop /app/share/applications/org.metamuffin.hurrycurry.client.desktop
      - install -Dm644 org.metamuffin.hurrycurry.client.metainfo.xml /app/share/metainfo/org.metamuffin.hurrycurry.client.metainfo.xml
      - >
        for size in {32,64,128,256,512}; do
          ffmpeg -i client/icon.png -vf scale=${size}:${size} "$size.png"
          install -Dm644 "$size.png" "/app/share/icons/hicolor/${size}x${size}/apps/org.metamuffin.hurrycurry.client.png"
        done
