app-id: org.metamuffin.hurrycurry.client
runtime: org.freedesktop.Platform
runtime-version: "23.08"
sdk: org.freedesktop.Sdk
command: hurrycurry
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --device=dri
  - --share=network

build-options:
  arch:
    x86_64:
      env:
        # Only enable link-time optimization when targeting x86_64
        # (causes issues on other architectures)
        SCONS_FLAGS_EXTRA: use_lto=yes

  env:
    BUILD_NAME: hurrycurry

modules:
  - shared-modules/glu/glu-9.json

  - name: scons
    buildsystem: simple
    cleanup: ["*"]

    sources:
      - type: archive
        sha256: 6e928fc97984e719814270f6863f2183b3b72180b0162a5ed09db68c9994100c
        url: https://downloads.sourceforge.net/project/scons/scons/4.8.0/SCons-4.8.0.tar.gz

    build-commands:
      - python3 -m pip install --no-index --no-build-isolation --prefix=/app .

  - name: godot
    buildsystem: simple

    sources:
      - type: archive
        sha256: 751e55bfad8e04b846f9cf7b6eb80e058986a2cb1b103fc0fe6a4d8526a20e56
        url: https://downloads.tuxfamily.org/godotengine/4.3/godot-4.3-stable.tar.xz

      - type: file
        path: custom.py

    build-commands:
      - python3 /app/bin/scons $SCONS_FLAGS_EXTRA profile=custom.py target=editor -j "$FLATPAK_BUILDER_N_JOBS"
      - python3 /app/bin/scons $SCONS_FLAGS_EXTRA profile=custom.py target=template_release -j "$FLATPAK_BUILDER_N_JOBS"
      - install -Dm755 bin/godot.linuxbsd.template_release.* /app/bin/godot
      - install -Dm755 bin/godot.linuxbsd.editor.* /app/bin/godot-editor

  - name: hurrycurry
    buildsystem: simple
    sources:
      - type: archive
        sha256: 0bb49514884aafe091744cee1f8f95bb96da70f8722752e2e7d081058002cd1f
        url: https://codeberg.org/hurrycurry/hurrycurry/archive/v1.6.0.tar.gz

      - type: file
        sha256: 8f485bcd0e2d36ceed9ad3cdeb6369c034da2e53ff64ca0c8ebfb3de3f34777f
        url: https://s.metamuffin.org/static/hurrycurry-1.5/book.webp.tar.zst

      - type: archive
        sha256: 9ba36a8eee82d7a8395f1368482939a2181c405faf630a417acb2ad658f8016a
        url: https://codeberg.org/hurrycurry/hurrycurry-dist-extra/archive/v1.6.0.tar.gz

    build-commands:
      - tar -xf book.webp.tar.zst -C client/menu/book
      - install -dD /app/share/hurrycurry
      - godot-editor --headless --export-pack wasm32-unknown-unknown /app/share/hurrycurry/client.pck client/project.godot
      - rm /app/bin/godot-editor
      - install -Dm755 hurrycurry /app/bin/hurrycurry
      - install -Dm644 org.metamuffin.hurrycurry.client.desktop /app/share/applications/org.metamuffin.hurrycurry.client.desktop
      - install -Dm644 org.metamuffin.hurrycurry.client.metainfo.xml /app/share/metainfo/org.metamuffin.hurrycurry.client.metainfo.xml
      - >
        for size in {32,64,128,256,512}; do
          ffmpeg -i client/icon.png -vf scale=${size}:${size} "$size.png"
          install -Dm644 "$size.png" "/app/share/icons/hicolor/${size}x${size}/apps/org.metamuffin.hurrycurry.client.png"
        done
