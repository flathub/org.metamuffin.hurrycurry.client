app-id: org.metamuffin.hurrycurry.client
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node20
command: hurrycurry
finish-args:
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --device=all
  - --share=network

build-options:
  arch:
    x86_64:
      env:
        # Only enable link-time optimization when targeting x86_64
        # (causes issues on other architectures)
        SCONS_FLAGS_EXTRA: use_lto=yes
  env:
    BUILD_NAME: hurrycurry

modules:
  - shared-modules/glu/glu-9.json

  - name: scons
    buildsystem: simple
    cleanup: ["*"]
    sources:
      - type: archive
        sha256: e2d78aa56e4646e5dbaf50c0758c6d1e4b0418464d8d6d07a09beb6cf257538f
        url: https://downloads.sourceforge.net/project/scons/scons/4.9.1/SCons-4.9.1.tar.gz
    build-commands:
      - python3 -m pip install --no-index --no-build-isolation --prefix=/app .

  - name: godot
    buildsystem: simple
    sources:
      - type: archive
        sha256: 559e11bdd85033640d49db67baa6f15be1128b2af38a5acc06e02b53363d8dde
        url: https://github.com/godotengine/godot/releases/download/4.5.1-stable/godot-4.5.1-stable.tar.xz

      - type: file
        path: custom.py

    build-commands:
      - python3 /app/bin/scons $SCONS_FLAGS_EXTRA profile=custom.py target=editor -j "$FLATPAK_BUILDER_N_JOBS"
      - python3 /app/bin/scons $SCONS_FLAGS_EXTRA profile=custom.py target=template_release -j "$FLATPAK_BUILDER_N_JOBS"
      - install -Dm755 bin/godot.linuxbsd.template_release.* /app/bin/godot
      - install -Dm755 bin/godot.linuxbsd.editor.* /app/bin/godot-editor

  - name: rust
    buildsystem: simple
    build-options:
      strip: false
      no-debuginfo: true
    cleanup: ["*"]

    sources:
      - type: archive
        only-arches:
          - aarch64
        dest: rust
        url: https://static.rust-lang.org/dist/2025-10-09/rust-nightly-aarch64-unknown-linux-gnu.tar.xz
        sha256: f7bf703941809692bbc597a91096ff07e7aa7c151f5f246b698d60f0c2c6272e
      - type: archive
        only-arches:
          - x86_64
        dest: rust
        url: https://static.rust-lang.org/dist/2025-10-09/rust-nightly-x86_64-unknown-linux-gnu.tar.xz
        sha256: dc789cf72265f801f3bb9a6aea5a075b9a682556a85bbcba852597c1cd7efc17
    build-commands:
      - cd rust && ./install.sh --prefix=/app/sdk/rust-nightly --without=rust-docs --without=rust-docs-json-preview --disable-ldconfig --verbose

  - name: hurrycurry
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node20/bin:/app/sdk/rust-nightly/bin
      env:
        CARGO_HOME: /run/build/hurrycurry/cargo
        HURRYCURRY_DATA_PATH: /app/share/hurrycurry/data
    sources:
      - type: archive
        sha256: 6381a8384c0fd2b36f7bb9d8d5269346428c07a7585eb93812200c71ba0899d7
        url: https://codeberg.org/hurrycurry/hurrycurry/archive/v3.0.1.tar.gz
      - generated-sources.json

    build-commands:
      - sed -i "s/^const DISTRIBUTION := .*/const DISTRIBUTION := \"flatpak\"/" client/global.gd
      - cargo --offline fetch --manifest-path Cargo.toml
      - make all_data JSR=node
      - cargo build --frozen --release --bin hurrycurry-server
      - cargo build --frozen --release --bin hurrycurry-discover
      - install -Dm755 target/release/hurrycurry-server /app/bin/hurrycurry-server
      - install -Dm755 target/release/hurrycurry-discover /app/bin/hurrycurry-discover
      - install -dD /app/share/hurrycurry/data/recipes
      - install -dD /app/share/hurrycurry/data/maps
      - install -Dm644 data/index.yaml /app/share/hurrycurry/data/index.yaml
      - install -Dm644 -t /app/share/hurrycurry/data/recipes data/recipes/*.yaml
      - install -Dm644 -t /app/share/hurrycurry/data/maps data/maps/*.yaml
      - godot-editor --headless --export-pack wasm32-unknown-unknown /app/share/hurrycurry/client.pck client/project.godot
      - rm /app/bin/godot-editor
      - >
        for size in {32,64,128,256,512}; do
          ffmpeg -i client/icons/main.png -vf scale=${size}:${size} "$size.png"
          install -Dm644 "$size.png" "/app/share/icons/hicolor/${size}x${size}/apps/org.metamuffin.hurrycurry.client.png"
        done

  - name: hurrycurry-dist
    buildsystem: simple
    sources:
      - type: archive
        sha256: 08d83a37674169dfc1bb7cd70deb2fb6a29b1ec93080fc62bdfbbbc845b99e85
        url: https://codeberg.org/hurrycurry/hurrycurry-dist-extra/archive/v3.0.1.tar.gz
      - type: script
        dest-filename: hurrycurry
        commands:
          - exec /app/bin/godot --main-pack /app/share/hurrycurry/client.pck $@
    build-commands:
      - python translate.py
      - install -Dm755 hurrycurry /app/bin/hurrycurry
      - install -Dm644 org.metamuffin.hurrycurry.client.desktop /app/share/applications/org.metamuffin.hurrycurry.client.desktop
      - install -Dm644 org.metamuffin.hurrycurry.client.metainfo.xml /app/share/metainfo/org.metamuffin.hurrycurry.client.metainfo.xml
